<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>density: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">density
   </div>
   <div id="projectbrief">C++11 library for paged memory management, function queues, heterogeneous queues and lifo memory management</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="contents">
<div class="textblock"><h2>Benchmarks of lifo_array </h2>
<hr/>
<p>In this tests <a class="el" href="classdensity_1_1lifo__array.html">lifo_array</a> is compared with a legacy heap array, the function <a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/alloca">_alloca</a>, and the function <a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/malloca">_malloca</a> (a Microsoft-specific safer version). A comparison with <code>std::vector</code> wouldn't be fair because <code>std::vector</code> value-initializes the elements even if they are pod types, while lifo_array doesn't.</p>
<p>The benchmark is composed by two tests:</p>
<ul>
<li>An array of <code>float</code>s is allocated, the first element is zeroed, and then the array is deallocated.</li>
<li>An array of <code>double</code>s is allocated, the first element is zeroed, and then the array is deallocated. This test is an head-to-head between <code>alloca</code> and <code>lifo_array</code>.</li>
</ul>
<h2>Summary of the results </h2>
<p>All the tests are compiled with Visual Studio 2017 (version 15.1), and executed on Windows 10 with an int Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz, 2808 Mhz, 4 cores, 8 logical processors. The benchmarks of the whole library are shuffled and interleaved at the granularity of a single invocation with a given cardinality, and every invocation occurs 8 times.</p>
<p>The results are quite noisy: there are two separate classes of players, but no clear winner in each of them.</p>
<ul>
<li><code>_malloca</code> is roughly the same to the array on the heap (actually many times it's slower). The reason is that this function allocates on the heap sizes bigger than 1024 bytes, and the tests allocate up to 30-40 kibibytes. Note that <code>_malloca</code> needs a deallocation function to be called (<a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/freea">_freea</a>), and that it can still possibly cause a stack overflow, though much more rarely than <code>alloca</code>.</li>
<li><code>alloca</code> and <code>lifo_array</code> are very close, with the first being ~80% of times slightly faster if the size an element is not a multiple of <a class="el" href="classdensity_1_1lifo__allocator.html#ac15e6b5f88a94c672b70f8a914798517">lifo_allocator::alignment</a> (currently = <code>alignof(void*)</code>). Otherwise <code>lifo_array</code> can skip some ALU instructions that align the size of the block. I'm not sure that this is the reason, but this case it's often slightly faster than <code>alloca</code>. Anyway both <code>alloca</code> and <code>lifo_array</code> are very fast.</li>
</ul>
<h2>Generated code for lifo_array </h2>
<p>Visual Stdio 2017 translates the source code of first test:</p>
<div class="fragment"><div class="line">lifo_array&lt;char&gt; chars(i_cardinality);</div><div class="line"><span class="keyword">volatile</span> <span class="keywordtype">char</span> c = 0;</div><div class="line">chars[0] = c;</div></div><!-- fragment --><p>to this machine code:</p>
<div class="fragment"><div class="line">           lifo_array&lt;char&gt; chars(i_cardinality);</div><div class="line">mov         rax,qword ptr gs:[58h]  </div><div class="line">           lifo_array&lt;char&gt; chars(i_cardinality);</div><div class="line">lea         rdi,[rdx+7]  </div><div class="line">and         rdi,0FFFFFFFFFFFFFFF8h  </div><div class="line">mov         ebx,128h  </div><div class="line">add         rbx,qword ptr [rax]  </div><div class="line">mov         rdx,qword ptr [rbx]  </div><div class="line">mov         rcx,rdx  </div><div class="line">and         rcx,0FFFFFFFFFFFF0000h  </div><div class="line">lea         r8,[rdi+rdx]  </div><div class="line">mov         rax,r8  </div><div class="line">sub         rax,rcx  </div><div class="line">cmp         rax,0FFF0h  </div><div class="line">jb          &lt;lambda_b8a4ec06313d93817536a7cf8b449dcc&gt;::operator()+57h (07FF72B438037h)  </div><div class="line">mov         rdx,rdi  </div><div class="line">mov         rcx,rbx  </div><div class="line">call        <a class="code" href="namespacedensity.html">density</a>::lifo_allocator&lt;<a class="code" href="namespacedensity.html">density</a>::basic_void_allocator&lt;65536&gt; &gt;::allocate_slow_path (07FF72B4385B0h)  </div><div class="line">mov         rdx,rax  </div><div class="line">jmp         &lt;lambda_b8a4ec06313d93817536a7cf8b449dcc&gt;::operator()+5Ah (07FF72B43803Ah)  </div><div class="line">mov         qword ptr [rbx],r8  </div><div class="line">           volatile <span class="keywordtype">char</span> c = 0;</div><div class="line">mov         byte ptr [rsp+30h],0  </div><div class="line">           chars[0] = c;</div><div class="line">movzx       eax,byte ptr [c]  </div><div class="line">mov         byte ptr [rdx],al  </div><div class="line">       }</div><div class="line">mov         rax,qword ptr [rbx]  </div><div class="line">xor         rax,rdx  </div><div class="line">test        rax,0FFFFFFFFFFFF0000h  </div><div class="line">je          &lt;lambda_b8a4ec06313d93817536a7cf8b449dcc&gt;::operator()+89h (07FF72B438069h)  </div><div class="line">mov         r8,rdi  </div><div class="line">mov         rcx,rbx  </div><div class="line">mov         rbx,qword ptr [rsp+38h]  </div><div class="line">add         rsp,20h  </div><div class="line">pop         rdi  </div><div class="line">jmp         <a class="code" href="namespacedensity.html">density</a>::lifo_allocator&lt;<a class="code" href="namespacedensity.html">density</a>::basic_void_allocator&lt;65536&gt; &gt;::deallocate_slow_path (07FF72B438520h)  </div><div class="line">mov         qword ptr [rbx],rdx  </div><div class="line">mov         rbx,qword ptr [rsp+38h]  </div></div><!-- fragment --><p>The branch after <code>cmp</code> and the one after <code>test</code> skip the slow paths. They are always taken unless a page switch is required, or the requested block does not fit in a page (in which case the block is allocated in the heap). The branch predictor of the cpu should do a good job here.</p>
<p>Note that the first instructions align the size of the block to 8 bytes.</p>
<p>The source code of second test:</p>
<div class="fragment"><div class="line">lifo_array&lt;double&gt; chars(i_cardinality);</div><div class="line"><span class="keyword">volatile</span> <span class="keywordtype">double</span> c = 0;</div><div class="line">chars[0] = c;</div></div><!-- fragment --><p>is translated to:</p>
<div class="fragment"><div class="line">           lifo_array&lt;double&gt; chars(i_cardinality);</div><div class="line">mov         rax,qword ptr gs:[58h]  </div><div class="line">           lifo_array&lt;double&gt; chars(i_cardinality);</div><div class="line">lea         rdi,[rdx*8]  </div><div class="line">mov         ebx,128h  </div><div class="line">add         rbx,qword ptr [rax]  </div><div class="line">mov         rdx,qword ptr [rbx]  </div><div class="line">mov         rcx,rdx  </div><div class="line">and         rcx,0FFFFFFFFFFFF0000h  </div><div class="line">lea         r8,[rdx+rdi]  </div><div class="line">mov         rax,r8  </div><div class="line">sub         rax,rcx  </div><div class="line">cmp         rax,0FFF0h  </div><div class="line">jb          &lt;lambda_c7840347498da9fa856125956fe6e478&gt;::operator()+57h (07FF74CD28457h)  </div><div class="line">mov         rdx,rdi  </div><div class="line">mov         rcx,rbx  </div><div class="line">call        <a class="code" href="namespacedensity.html">density</a>::lifo_allocator&lt;<a class="code" href="namespacedensity.html">density</a>::basic_void_allocator&lt;65536&gt; &gt;::allocate_slow_path (07FF74CD285B0h)  </div><div class="line">mov         rdx,rax  </div><div class="line">jmp         &lt;lambda_c7840347498da9fa856125956fe6e478&gt;::operator()+5Ah (07FF74CD2845Ah)  </div><div class="line">mov         qword ptr [rbx],r8  </div><div class="line">xorps       xmm0,xmm0  </div><div class="line">           volatile <span class="keywordtype">double</span> c = 0;</div><div class="line">movsd       mmword ptr [rsp+30h],xmm0  </div><div class="line">           chars[0] = c;</div><div class="line">movsd       xmm1,mmword ptr [c]  </div><div class="line">       }</div><div class="line">mov         rax,qword ptr [rbx]  </div><div class="line">xor         rax,rdx  </div><div class="line">           chars[0] = c;</div><div class="line">movsd       mmword ptr [rdx],xmm1  </div><div class="line">       }</div><div class="line">test        rax,0FFFFFFFFFFFF0000h  </div><div class="line">je          &lt;lambda_c7840347498da9fa856125956fe6e478&gt;::operator()+90h (07FF74CD28490h)  </div><div class="line">mov         r8,rdi  </div><div class="line">mov         rcx,rbx  </div><div class="line">mov         rbx,qword ptr [rsp+38h]  </div><div class="line">add         rsp,20h  </div><div class="line">       }</div><div class="line">pop         rdi  </div><div class="line">jmp         <a class="code" href="namespacedensity.html">density</a>::lifo_allocator&lt;<a class="code" href="namespacedensity.html">density</a>::basic_void_allocator&lt;65536&gt; &gt;::deallocate_slow_path (07FF74CD28520h)  </div><div class="line">mov         qword ptr [rbx],rdx  </div><div class="line">mov         rbx,qword ptr [rsp+38h]  </div></div><!-- fragment --><p>In this case the size of the array is always aligned to 8 bytes, so there is some less ALU instructions.</p>
<h2>Results of the first test </h2>
<div class="image">
<img src="lifo_array_b1_1.png" alt="lifo_array_b1_1.png"/>
</div>
 <div class="image">
<img src="lifo_array_b1_2.png" alt="lifo_array_b1_2.png"/>
</div>
 <div class="image">
<img src="lifo_array_b1_3.png" alt="lifo_array_b1_3.png"/>
</div>
<h2>Results of the second test </h2>
<div class="image">
<img src="lifo_array_b2_1.png" alt="lifo_array_b2_1.png"/>
</div>
 <div class="image">
<img src="lifo_array_b2_2.png" alt="lifo_array_b2_2.png"/>
</div>
 <div class="image">
<img src="lifo_array_b2_3.png" alt="lifo_array_b2_3.png"/>
</div>
 </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
